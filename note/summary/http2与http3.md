#### HTTP/2

* `http2`相对于`http1.1`来说大幅度提高了网页的性能。在`http1`中，为了性能考虑，我们会引入雪碧图，使用多个域名等。这都是因为浏览器限制了同一个域名下的请求数量（chrome一般限制六个），当页面中需要请求很多资源时，队头阻塞会导致在达到最大请求数量时。剩下资源需要等待其他资源请求完后才发起请求。因此`http2`中引入了多路复用，可以通过一个`tcp`连接就可以传输所有请求数据。多路复用很好解决了浏览器限制同一域名下的请求数量问题。同时也间接更容易实现全速传输。因为一个`tcp`连接都需要慢慢提升传输速度。

`http`新增的功能：

1. 二进制分帧
2. header压缩
3. 流量控制
4. 多路复用
5. 请求优先级
6. 服务端push

##### 1. 二进制分帧

* 关于帧：
  1. 帧： http2通信的最小单位。所有帧都共享一个8字节首部，其中包含帧长，类型，标志，还有一个保留位。
  2. 消息： 比帧大的通讯单位，是指逻辑上的http消息，比如请求，响应等。由一个或多个帧组成
  3. 流： 比消息大的通讯单位，是tcp连接中的一个虚拟通道，可以承载双向的消息，每个流都有一个唯一的整数标识符。

* 在`http1.1`之前，都是通过文本的方式传输数据。在`http2`中引入了新的编码机制，所有传输的数据都会被分割为更小的消息和帧，并采用二进制格式的编码将其封装，首部信息封装到Headers帧中，而request body将被封装到data帧中。这也是`http2`加强新能的核心点
* 二进制分帧如何工作： http2通讯都是在一个tcp连接上完成，这连接可承载任意数据的双向数据流。相应的每个数据流可以是消息的形式发送。而消息又是由多个帧组成，些帧可以乱序发送，然后根据每个帧首部的流标识符重新组装。
* 对性能优化贡献：
  1. 在单链接多资源方式中，减少服务端的链接压力，内存占用更少，；链接吞吐量更大。
  2. 由于减少tcp连接的减少而使网络拥塞状态得以改善，同时慢启动时间减少（tcp连接需要慢慢启动），

##### 2. 多路复用

* 多路复用就是一个`tcp`连接中可以存在多条流，也就是说可以发生多个请求
* 对性能优化贡献：
  1. 可以并行交错的发送请求和响应，这些请求和响应之间互不影响
  2. 只使用一个连接就可以并行发送多个请求和响应
  3. 消除不必要的延迟，从而减少页面加载的时间
  4. 不必再为绕过http1.x限制而多做很多工作

##### 3. header 压缩

* 在`http/1`中，使用文本的形式传输header，在header携带cookie的情况下，可能每次都需要重复传输几百到几千的字节
* `http/2`中，使用`HPACK`压缩格式对传输的header进行编码，减少header大小。
* 在两端维护了索引表，用于记录出现过的header，后面在传输过程中就可以传输已经记录过header的健名。对端收到数据后就可以通过健名找到对应的值。
* 对性能优化贡献：
  * 使报头更紧凑，更快速传输，有利于移动网路环境，减少每次通讯的数据量。



##### 4. 流量控制

* 流量基于HTTP链接的每一跳进行，而非端到端的控制

* 流量控制基于窗口更新帧进行，即接收方广播自己准备接收某个数据流的多少字节，以及对整个链接要接收多少个字节。

* 流量控制有方向性，即接收方可能根据自己的情况为每个流乃至整个链接设置任意窗口大小

* 流量控制可以由接收方禁用，包括针对个别的流和针对整个链接。

* 帧的类型决定了流量控制是否适用于帧，目前只有DATA帧服从流量控制，所有其他类型的帧并不会消耗流量控制窗口的空间。这保证了重要的控制帧不会被流量控制阻塞

##### 5. 请求优先级

* http2把消息分为很多独立帧后，就可以通过优化这些帧的交错和传输顺序进一步优化新能
* 每个流都可以带有一个31bit的优先值：0表示最高优先级；2的31次方-1表示最低优先级
* 客户端可以明确指定优先级，服务端可以根据这个优先级作为交互数据的依据。服务端按此顺序返回结果更加有利于高效利用底层连接，提高用户体验。需要注意的是服务端是否支持请求优先级，是否会引起阻塞问题，比如高优先级的慢响应请求会阻塞其他资源的交互。
* 性能优化贡献： 
  * 服务器可以根据流的优先级控制资源分配，而在响应数据准备好之后，优先将最高优先级的帧发送给客户端
  * 浏览器可以在发现资源时立即分派请求，指定每个流的优先级，让服务器决定最优的响应次序
  * 

##### 6. 服务端push

* `http/2`中，服务端可以在客户端请求某个后，主动推送其他资源。



##### `http2`的缺点

* `http2`使用了多路复用，一般来说同一个域名下只需要使用一个`tcp`连接。当这个连接出现丢包的情况，就会导致`http2`的表现还不如`http1`。因为出现丢包情况，整个`tcp`都要等待开始重传，也就导致后面所有的数据都被阻塞了。但对于`http1`来说可以开启多个`tcp`出现这种情况只会影响其中一个连接。剩余的连接可以正常传输数据。



#### `http/3`

* 由于`http/2`的缺点，`google`做了一个基于`UDP`协议的`QUIC`协议。并使用在了`http/3`上。

##### 1. QUIC

* `QUIC` 虽然基于 `UDP`，但是在原本的基础上新增了很多功能，比如多路复用、`0-RTT`、使用 `TLS1.3` 加密、流量控制、有序交付、重传等等功能。

1. 多路复用： 虽然 HTTP/2 支持了多路复用，但是 TCP 协议终究是没有这个功能的。`QUIC `原生就实现了这个功能，并且传输的单个数据流可以**保证有序交付且不会影响其他的数据流**，这样的技术就解决了之前 TCP 存在的问题

   并且 QUIC 在移动端的表现也会比 TCP 好。因为 TCP 是基于 IP 和端口去识别连接的，这种方式在多变的移动端网络环境下是很脆弱的。但是 QUIC 是通过 ID 的方式去识别一个连接，不管你网络环境如何变化，只要 ID 不变，就能迅速重连上。

2. O-RTT

   * 通过使用类似tcp快速打开的技术，缓存当前回话的上下文，在下次恢复会话的时候，值需要将之前的缓存传递给服务端验证通过就可以进行传输了

3. 纠错机制

   * 假如说这次我要发送三个包，那么协议会算出这三个包的异或值并单独发出一个校验包，也就是总共发出了四个包。

     当出现其中的非校验包丢包的情况时，可以通过另外三个包计算出丢失的数据包的内容。

     当然这种技术只能使用在丢失一个包的情况下，如果出现丢失多个包就不能使用纠错机制了，只能使用重传的方式了。